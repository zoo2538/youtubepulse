<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©±ë“± ë³µì› ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ë©±ë“± ë³µì› ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h3>1. IndexedDB ë©±ë“±ì„± í…ŒìŠ¤íŠ¸</h3>
            <p>ê°™ì€ ë°ì´í„°ë¥¼ ë‘ ë²ˆ ë³µì›í•´ë„ ê²°ê³¼ê°€ ë™ì¼í•œì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button class="test-button" onclick="runIdempotencyTest()">ë©±ë“±ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="idempotency-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>2. ì¤‘ë³µ ê²€ì‚¬</h3>
            <p>í˜„ì¬ IndexedDBì— ì¤‘ë³µ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
            <button class="test-button" onclick="runDuplicateCheck()">ì¤‘ë³µ ê²€ì‚¬ ì‹¤í–‰</button>
            <div id="duplicate-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>3. ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸</h3>
            <p>ê°™ì€ ì˜ìƒì˜ ì¡°íšŒìˆ˜ê°€ ë” ë†’ì€ ê°’ìœ¼ë¡œ ë³‘í•©ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button class="test-button" onclick="runMaxValueTest()">ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸</button>
            <div id="maxvalue-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>4. ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h3>
            <p>ëª¨ë“  ê¸°ëŠ¥ì„ ì¢…í•©ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button class="test-button" onclick="runFullTest()">ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="full-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // IndexedDB ì—´ê¸°
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('YouTubePulseDB', 10);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ë©±ë“±ì„± í…ŒìŠ¤íŠ¸
        async function runIdempotencyTest() {
            const resultDiv = document.getElementById('idempotency-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'ğŸ”„ ë©±ë“±ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                const db = await openDB();
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                const testData = [
                    {
                        videoId: 'test-video-1',
                        dayKeyLocal: '2025-10-05',
                        viewCount: 1000,
                        likeCount: 50,
                        channelName: 'Test Channel',
                        videoTitle: 'Test Video 1'
                    }
                ];
                
                // ì²« ë²ˆì§¸ ë³µì›
                const result1 = await batchIdempotentRestore(testData);
                
                // ë‘ ë²ˆì§¸ ë³µì› (ê°™ì€ ë°ì´í„°)
                const result2 = await batchIdempotentRestore(testData);
                
                // ë©±ë“±ì„± ê²€ì¦
                const isIdempotent = result1.success === result2.success && 
                                  result1.merged === result2.merged && 
                                  result1.new === result2.new;
                
                resultDiv.className = `result ${isIdempotent ? 'success' : 'error'}`;
                resultDiv.textContent = `ë©±ë“±ì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${isIdempotent ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'}
ì²« ë²ˆì§¸ ë³µì›: ì„±ê³µ ${result1.success}ê°œ, ë³‘í•© ${result1.merged}ê°œ, ì‹ ê·œ ${result1.new}ê°œ
ë‘ ë²ˆì§¸ ë³µì›: ì„±ê³µ ${result2.success}ê°œ, ë³‘í•© ${result2.merged}ê°œ, ì‹ ê·œ ${result2.new}ê°œ`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ì¤‘ë³µ ê²€ì‚¬
        async function runDuplicateCheck() {
            const resultDiv = document.getElementById('duplicate-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'ğŸ”„ ì¤‘ë³µ ê²€ì‚¬ ì‹¤í–‰ ì¤‘...';
            
            try {
                const duplicateCheck = await checkDuplicates();
                
                resultDiv.className = `result ${duplicateCheck.duplicates === 0 ? 'success' : 'error'}`;
                resultDiv.textContent = `ì¤‘ë³µ ê²€ì‚¬ ê²°ê³¼: ${duplicateCheck.duplicates === 0 ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'}
ì´ ë ˆì½”ë“œ: ${duplicateCheck.total}ê°œ
ê³ ìœ  ì¡°í•©: ${duplicateCheck.unique}ê°œ
ì¤‘ë³µ: ${duplicateCheck.duplicates}ê°œ

${duplicateCheck.duplicateDetails.length > 0 ? 'ì¤‘ë³µ ìƒì„¸:\n' + duplicateCheck.duplicateDetails.map(d => `  ${d.key}: ${d.count}ê°œ`).join('\n') : ''}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì¤‘ë³µ ê²€ì‚¬ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸
        async function runMaxValueTest() {
            const resultDiv = document.getElementById('maxvalue-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'ğŸ”„ ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                const db = await openDB();
                
                // ë‚®ì€ ì¡°íšŒìˆ˜ ë°ì´í„°
                const lowData = [{
                    videoId: 'max-test-video',
                    dayKeyLocal: '2025-10-05',
                    viewCount: 1000,
                    likeCount: 50,
                    channelName: 'Test Channel',
                    videoTitle: 'Max Test Video'
                }];
                
                // ë†’ì€ ì¡°íšŒìˆ˜ ë°ì´í„°
                const highData = [{
                    videoId: 'max-test-video',
                    dayKeyLocal: '2025-10-05',
                    viewCount: 2000, // ë” ë†’ì€ ì¡°íšŒìˆ˜
                    likeCount: 100,  // ë” ë†’ì€ ì¢‹ì•„ìš”
                    channelName: 'Test Channel',
                    videoTitle: 'Max Test Video Updated'
                }];
                
                // ë‚®ì€ ê°’ ë¨¼ì € ì €ì¥
                await batchIdempotentRestore(lowData);
                
                // ë†’ì€ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                await batchIdempotentRestore(highData);
                
                // ê²°ê³¼ í™•ì¸
                const transaction = db.transaction(['unclassifiedData'], 'readonly');
                const store = transaction.objectStore('unclassifiedData');
                const videoDayIndex = store.index('videoDay');
                const getRequest = videoDayIndex.get(['max-test-video', '2025-10-05']);
                
                getRequest.onsuccess = () => {
                    const result = getRequest.result;
                    const isMaxValue = result && result.viewCount === 2000 && result.likeCount === 100;
                    
                    resultDiv.className = `result ${isMaxValue ? 'success' : 'error'}`;
                    resultDiv.textContent = `ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${isMaxValue ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'}
ì €ì¥ëœ ì¡°íšŒìˆ˜: ${result ? result.viewCount : 'ì—†ìŒ'}
ì €ì¥ëœ ì¢‹ì•„ìš”: ${result ? result.likeCount : 'ì—†ìŒ'}
ì˜ˆìƒ ì¡°íšŒìˆ˜: 2000
ì˜ˆìƒ ì¢‹ì•„ìš”: 100`;
                };
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ìµœëŒ€ê°’ ë³‘í•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸
        async function runFullTest() {
            const resultDiv = document.getElementById('full-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'ğŸ”„ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                await runIdempotencyTest();
                await runDuplicateCheck();
                await runMaxValueTest();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\nëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.';
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ë°°ì¹˜ ë©±ë“± ë³µì› í•¨ìˆ˜
        async function batchIdempotentRestore(data) {
            const db = await openDB();
            const transaction = db.transaction(['unclassifiedData'], 'readwrite');
            const store = transaction.objectStore('unclassifiedData');
            const videoDayIndex = store.index('videoDay');
            
            let successCount = 0;
            let mergedCount = 0;
            let newCount = 0;
            
            for (const item of data) {
                try {
                    const key = [item.videoId, item.dayKeyLocal];
                    const getRequest = videoDayIndex.get(key);
                    
                    await new Promise((resolve, reject) => {
                        getRequest.onsuccess = () => {
                            if (getRequest.result) {
                                // ê¸°ì¡´ ë ˆì½”ë“œê°€ ìˆìœ¼ë©´ ìµœëŒ€ê°’ìœ¼ë¡œ ë³‘í•©
                                const existing = getRequest.result;
                                const merged = {
                                    ...existing,
                                    viewCount: Math.max(existing.viewCount || 0, item.viewCount || 0),
                                    likeCount: Math.max(existing.likeCount || 0, item.likeCount || 0),
                                    channelName: item.channelName || existing.channelName,
                                    videoTitle: item.videoTitle || existing.videoTitle,
                                    updatedAt: new Date().toISOString()
                                };
                                
                                const putRequest = store.put(merged);
                                putRequest.onsuccess = () => {
                                    mergedCount++;
                                    successCount++;
                                    resolve();
                                };
                                putRequest.onerror = () => reject(putRequest.error);
                            } else {
                                // ìƒˆ ë ˆì½”ë“œ ì¶”ê°€
                                const newItem = {
                                    ...item,
                                    id: item.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                    createdAt: item.createdAt || new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                const addRequest = store.add(newItem);
                                addRequest.onsuccess = () => {
                                    newCount++;
                                    successCount++;
                                    resolve();
                                };
                                addRequest.onerror = () => reject(addRequest.error);
                            }
                        };
                        
                        getRequest.onerror = () => reject(getRequest.error);
                    });
                } catch (error) {
                    console.error(`âŒ ë ˆì½”ë“œ ì²˜ë¦¬ ì‹¤íŒ¨ ${item.videoId}:`, error);
                }
            }
            
            return {
                total: data.length,
                success: successCount,
                merged: mergedCount,
                new: newCount
            };
        }

        // ì¤‘ë³µ ê²€ì‚¬ í•¨ìˆ˜
        async function checkDuplicates() {
            const db = await openDB();
            const transaction = db.transaction(['unclassifiedData'], 'readonly');
            const store = transaction.objectStore('unclassifiedData');
            const getAllRequest = store.getAll();
            
            return new Promise((resolve, reject) => {
                getAllRequest.onsuccess = () => {
                    const allData = getAllRequest.result;
                    const groups = {};
                    
                    allData.forEach(item => {
                        const key = `${item.videoId}-${item.dayKeyLocal || item.collectionDate?.split('T')[0]}`;
                        if (!groups[key]) {
                            groups[key] = [];
                        }
                        groups[key].push(item);
                    });
                    
                    const duplicates = Object.entries(groups)
                        .filter(([key, items]) => items.length > 1)
                        .map(([key, items]) => ({
                            key,
                            count: items.length,
                            items: items.map(item => ({
                                id: item.id,
                                viewCount: item.viewCount,
                                createdAt: item.createdAt
                            }))
                        }));
                    
                    resolve({
                        total: allData.length,
                        unique: Object.keys(groups).length,
                        duplicates: duplicates.length,
                        duplicateDetails: duplicates
                    });
                };
                
                getAllRequest.onerror = () => reject(getAllRequest.error);
            });
        }
    </script>
</body>
</html>
