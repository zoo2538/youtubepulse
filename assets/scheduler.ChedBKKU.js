var u=Object.defineProperty;var h=(n,e,t)=>e in n?u(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>h(n,typeof e!="symbol"?e+"":e,t);import{i}from"./services.D3WlFT8g.js";class d{constructor(){l(this,"metadata",{lastRunAt:"",lastDateProcessed:"",inFlight:!1});l(this,"STORAGE_KEY","auto_collection_metadata");l(this,"MUTEX_KEY","auto_collection_mutex");this.loadMetadata(),this.initialize()}loadMetadata(){try{const e=localStorage.getItem(this.STORAGE_KEY);e&&(this.metadata={...this.metadata,...JSON.parse(e)})}catch(e){console.error("âŒ ìë™ ìˆ˜ì§‘ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",e)}}saveMetadata(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.metadata))}catch(e){console.error("âŒ ìë™ ìˆ˜ì§‘ ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:",e)}}initialize(){this.checkAndRun(),document.addEventListener("visibilitychange",()=>{document.hidden||(console.log("ğŸ”„ í˜ì´ì§€ ê°€ì‹œì„± ë³µì› - ìë™ ìˆ˜ì§‘ í™•ì¸"),this.checkAndRun())})}async checkAndRun(){if(this.metadata.inFlight){console.log("â­ï¸ ìë™ ìˆ˜ì§‘ ì´ë¯¸ ì§„í–‰ ì¤‘");return}const e=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});if(this.metadata.lastDateProcessed===e){console.log("â­ï¸ ì˜¤ëŠ˜ ìë™ ìˆ˜ì§‘ ì´ë¯¸ ì™„ë£Œ:",e);return}console.log("ğŸ”„ ìë™ ìˆ˜ì§‘ í•„ìš”:",e),await this.runCollection(e)}async runCollection(e){if(sessionStorage.getItem(this.MUTEX_KEY)){console.log("â­ï¸ ìë™ ìˆ˜ì§‘ ë®¤í…ìŠ¤ ì°¨ë‹¨");return}this.metadata.inFlight=!0,sessionStorage.setItem(this.MUTEX_KEY,"true");const t=Date.now();console.log(`ğŸ”„ ìë™ ìˆ˜ì§‘ ì‹œì‘: ${e} (${new Date().toISOString()})`);try{await this.executeServerCollection(e),await this.saveToIndexedDB(e),this.metadata.lastRunAt=new Date().toISOString(),this.metadata.lastDateProcessed=e,this.saveMetadata();const o=Date.now()-t;console.log(`âœ… ìë™ ìˆ˜ì§‘ ì™„ë£Œ: ${e} (${o}ms)`)}catch(o){console.error("âŒ ìë™ ìˆ˜ì§‘ ì‹¤íŒ¨:",o),await this.enqueueRetry(e)}finally{this.metadata.inFlight=!1,sessionStorage.removeItem(this.MUTEX_KEY)}}async executeServerCollection(e){console.log("ğŸ”„ ì„œë²„ ìë™ ìˆ˜ì§‘ ì‹¤í–‰:",e);try{const t=await fetch("https://api.youthbepulse.com/api/auto-collect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dateKey:e})});if(!t.ok)throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${t.status}`);const o=await t.json();console.log("âœ… ì„œë²„ ìë™ ìˆ˜ì§‘ ì„±ê³µ:",o)}catch(t){throw console.error("âŒ ì„œë²„ ìë™ ìˆ˜ì§‘ ì‹¤íŒ¨:",t),t}}async saveToIndexedDB(e){console.log("ğŸ”„ IndexedDB ì €ì¥:",e);try{await new Promise(t=>setTimeout(t,500)),console.log("âœ… IndexedDB ì €ì¥ ì™„ë£Œ")}catch(t){throw console.error("âŒ IndexedDB ì €ì¥ ì‹¤íŒ¨:",t),t}}async enqueueRetry(e){console.log("ğŸ”„ ì¬ì‹œë„ íì— ì¶”ê°€:",e);try{const t=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");t.push({dateKey:e,timestamp:Date.now(),retryCount:0}),localStorage.setItem("auto_collection_retry_queue",JSON.stringify(t)),console.log("âœ… ì¬ì‹œë„ íì— ì¶”ê°€ ì™„ë£Œ")}catch(t){console.error("âŒ ì¬ì‹œë„ í ì¶”ê°€ ì‹¤íŒ¨:",t)}}async processRetryQueue(){try{const e=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");if(e.length===0)return;console.log(`ğŸ”„ ì¬ì‹œë„ í ì²˜ë¦¬: ${e.length}ê°œ í•­ëª©`);for(const t of e)try{await this.runCollection(t.dateKey);const o=e.filter(r=>r!==t);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(o))}catch(o){if(console.error("âŒ ì¬ì‹œë„ ì‹¤íŒ¨:",t.dateKey,o),t.retryCount++,t.retryCount>=3){const r=e.filter(s=>s!==t);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(r)),console.log("âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼:",t.dateKey)}}}catch(e){console.error("âŒ ì¬ì‹œë„ í ì²˜ë¦¬ ì‹¤íŒ¨:",e)}}async triggerManualCollection(){const e=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});await this.runCollection(e)}getMetadata(){return{...this.metadata}}}const g=new d;typeof window<"u"&&(window.autoCollectionScheduler=g);class m{constructor(){l(this,"telemetry",[])}async readWithServerFirst(e,t,o){const r=Date.now(),s=`fetch_${t}`;try{console.log(`ğŸ”„ ì„œë²„ ìš°ì„  ì½ê¸° ì‹œì‘: ${t}`);const a=await e();return console.log(`âœ… ì„œë²„ ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${t}`),await this.upsertToIndexedDB(t,a),console.log(`âœ… IndexedDB ìºì‹œ ì €ì¥: ${t}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0}),a}catch(a){console.error(`âŒ ì„œë²„ ì½ê¸° ì‹¤íŒ¨: ${t}`,a);try{const c=await this.getFromIndexedDB(o||t);return console.log(`ğŸ”„ IndexedDB í´ë°± ì‚¬ìš©: ${t}`),this.showOfflineBadge(),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0}),c}catch(c){throw console.error(`âŒ IndexedDB í´ë°± ì‹¤íŒ¨: ${t}`,c),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!1,error:c instanceof Error?c.message:"Unknown error"}),c}}}async writeWithServerFirst(e,t,o){const r=Date.now(),s=`save_${o}`;try{console.log(`ğŸ”„ ì„œë²„ ìš°ì„  ì“°ê¸° ì‹œì‘: ${o}`),await this.addToLocalQueue(o,e),console.log(`âœ… ë¡œì»¬ í ì¶”ê°€: ${o}`);const a=await t(e);console.log(`âœ… ì„œë²„ ì €ì¥ ì„±ê³µ: ${o}`),await this.upsertToIndexedDB(o,a),console.log(`âœ… IndexedDB ì„œë²„ ì‘ë‹µ ì—…ë°ì´íŠ¸: ${o}`),await this.removeFromLocalQueue(o),console.log(`âœ… ë¡œì»¬ í ì œê±°: ${o}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0})}catch(a){throw console.error(`âŒ ì„œë²„ ì“°ê¸° ì‹¤íŒ¨: ${o}`,a),console.log(`ğŸ”„ ë¡œì»¬ í ìœ ì§€ (ì¬ì‹œë„ ëŒ€ê¸°): ${o}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!1,error:a instanceof Error?a.message:"Unknown error"}),a}}async upsertToIndexedDB(e,t){try{const o=await this.getFromIndexedDB(e),r=this.mergeData(o,t);await i.saveData(e,r),console.log(`âœ… IndexedDB upsert ì™„ë£Œ: ${e}`)}catch(o){throw console.error(`âŒ IndexedDB upsert ì‹¤íŒ¨: ${e}`,o),o}}async getFromIndexedDB(e){try{return await i.loadData(e)}catch(t){throw console.error(`âŒ IndexedDB ì½ê¸° ì‹¤íŒ¨: ${e}`,t),t}}mergeData(e,t){return e?t?{...e,...t}:e:t}async addToLocalQueue(e,t){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]");o.push({key:e,data:t,timestamp:Date.now()}),localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(o){throw console.error("âŒ ë¡œì»¬ í ì¶”ê°€ ì‹¤íŒ¨:",o),o}}async removeFromLocalQueue(e){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]").filter(r=>r.key!==e);localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(t){throw console.error("âŒ ë¡œì»¬ í ì œê±° ì‹¤íŒ¨:",t),t}}showOfflineBadge(){console.log("ğŸ”„ ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”");const e=document.createElement("div");e.textContent="ì˜¤í”„ë¼ì¸ ëª¨ë“œ",e.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      z-index: 9999;
      font-size: 12px;
    `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}logTelemetry(e){this.telemetry.push(e),this.telemetry.length>100&&(this.telemetry=this.telemetry.slice(-100)),console.log(`ğŸ“Š í…”ë ˆë©”íŠ¸ë¦¬: ${e.operation} (${e.endTime-e.startTime}ms) ${e.success?"âœ…":"âŒ"}`)}getTelemetry(){return[...this.telemetry]}async retryLocalQueue(){try{const e=JSON.parse(localStorage.getItem("local_write_queue")||"[]");if(e.length===0){console.log("ğŸ”„ ì¬ì‹œë„í•  ë¡œì»¬ í ì—†ìŒ");return}console.log(`ğŸ”„ ë¡œì»¬ í ì¬ì‹œë„: ${e.length}ê°œ í•­ëª©`);for(const t of e)try{await this.writeWithServerFirst(t.data,async o=>(console.log("ğŸ”„ ì„œë²„ ì¬ì‹œë„:",t.key),o),t.key)}catch(o){console.error("âŒ ë¡œì»¬ í ì¬ì‹œë„ ì‹¤íŒ¨:",t.key,o)}}catch(e){console.error("âŒ ë¡œì»¬ í ì¬ì‹œë„ ì‹¤íŒ¨:",e)}}}const w=new m;typeof window<"u"&&(window.serverAuthoritativeService=w);export{g as a,w as s};
