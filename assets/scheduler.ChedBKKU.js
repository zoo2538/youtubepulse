var u=Object.defineProperty;var h=(n,e,t)=>e in n?u(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>h(n,typeof e!="symbol"?e+"":e,t);import{i}from"./services.D3WlFT8g.js";class d{constructor(){l(this,"metadata",{lastRunAt:"",lastDateProcessed:"",inFlight:!1});l(this,"STORAGE_KEY","auto_collection_metadata");l(this,"MUTEX_KEY","auto_collection_mutex");this.loadMetadata(),this.initialize()}loadMetadata(){try{const e=localStorage.getItem(this.STORAGE_KEY);e&&(this.metadata={...this.metadata,...JSON.parse(e)})}catch(e){console.error("❌ 자동 수집 메타데이터 로드 실패:",e)}}saveMetadata(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.metadata))}catch(e){console.error("❌ 자동 수집 메타데이터 저장 실패:",e)}}initialize(){this.checkAndRun(),document.addEventListener("visibilitychange",()=>{document.hidden||(console.log("🔄 페이지 가시성 복원 - 자동 수집 확인"),this.checkAndRun())})}async checkAndRun(){if(this.metadata.inFlight){console.log("⏭️ 자동 수집 이미 진행 중");return}const e=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});if(this.metadata.lastDateProcessed===e){console.log("⏭️ 오늘 자동 수집 이미 완료:",e);return}console.log("🔄 자동 수집 필요:",e),await this.runCollection(e)}async runCollection(e){if(sessionStorage.getItem(this.MUTEX_KEY)){console.log("⏭️ 자동 수집 뮤텍스 차단");return}this.metadata.inFlight=!0,sessionStorage.setItem(this.MUTEX_KEY,"true");const t=Date.now();console.log(`🔄 자동 수집 시작: ${e} (${new Date().toISOString()})`);try{await this.executeServerCollection(e),await this.saveToIndexedDB(e),this.metadata.lastRunAt=new Date().toISOString(),this.metadata.lastDateProcessed=e,this.saveMetadata();const o=Date.now()-t;console.log(`✅ 자동 수집 완료: ${e} (${o}ms)`)}catch(o){console.error("❌ 자동 수집 실패:",o),await this.enqueueRetry(e)}finally{this.metadata.inFlight=!1,sessionStorage.removeItem(this.MUTEX_KEY)}}async executeServerCollection(e){console.log("🔄 서버 자동 수집 실행:",e);try{const t=await fetch("https://api.youthbepulse.com/api/auto-collect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dateKey:e})});if(!t.ok)throw new Error(`서버 응답 오류: ${t.status}`);const o=await t.json();console.log("✅ 서버 자동 수집 성공:",o)}catch(t){throw console.error("❌ 서버 자동 수집 실패:",t),t}}async saveToIndexedDB(e){console.log("🔄 IndexedDB 저장:",e);try{await new Promise(t=>setTimeout(t,500)),console.log("✅ IndexedDB 저장 완료")}catch(t){throw console.error("❌ IndexedDB 저장 실패:",t),t}}async enqueueRetry(e){console.log("🔄 재시도 큐에 추가:",e);try{const t=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");t.push({dateKey:e,timestamp:Date.now(),retryCount:0}),localStorage.setItem("auto_collection_retry_queue",JSON.stringify(t)),console.log("✅ 재시도 큐에 추가 완료")}catch(t){console.error("❌ 재시도 큐 추가 실패:",t)}}async processRetryQueue(){try{const e=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");if(e.length===0)return;console.log(`🔄 재시도 큐 처리: ${e.length}개 항목`);for(const t of e)try{await this.runCollection(t.dateKey);const o=e.filter(r=>r!==t);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(o))}catch(o){if(console.error("❌ 재시도 실패:",t.dateKey,o),t.retryCount++,t.retryCount>=3){const r=e.filter(s=>s!==t);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(r)),console.log("❌ 최대 재시도 횟수 초과:",t.dateKey)}}}catch(e){console.error("❌ 재시도 큐 처리 실패:",e)}}async triggerManualCollection(){const e=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});await this.runCollection(e)}getMetadata(){return{...this.metadata}}}const g=new d;typeof window<"u"&&(window.autoCollectionScheduler=g);class m{constructor(){l(this,"telemetry",[])}async readWithServerFirst(e,t,o){const r=Date.now(),s=`fetch_${t}`;try{console.log(`🔄 서버 우선 읽기 시작: ${t}`);const a=await e();return console.log(`✅ 서버 데이터 로드 성공: ${t}`),await this.upsertToIndexedDB(t,a),console.log(`✅ IndexedDB 캐시 저장: ${t}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0}),a}catch(a){console.error(`❌ 서버 읽기 실패: ${t}`,a);try{const c=await this.getFromIndexedDB(o||t);return console.log(`🔄 IndexedDB 폴백 사용: ${t}`),this.showOfflineBadge(),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0}),c}catch(c){throw console.error(`❌ IndexedDB 폴백 실패: ${t}`,c),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!1,error:c instanceof Error?c.message:"Unknown error"}),c}}}async writeWithServerFirst(e,t,o){const r=Date.now(),s=`save_${o}`;try{console.log(`🔄 서버 우선 쓰기 시작: ${o}`),await this.addToLocalQueue(o,e),console.log(`✅ 로컬 큐 추가: ${o}`);const a=await t(e);console.log(`✅ 서버 저장 성공: ${o}`),await this.upsertToIndexedDB(o,a),console.log(`✅ IndexedDB 서버 응답 업데이트: ${o}`),await this.removeFromLocalQueue(o),console.log(`✅ 로컬 큐 제거: ${o}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!0})}catch(a){throw console.error(`❌ 서버 쓰기 실패: ${o}`,a),console.log(`🔄 로컬 큐 유지 (재시도 대기): ${o}`),this.logTelemetry({operation:s,startTime:r,endTime:Date.now(),success:!1,error:a instanceof Error?a.message:"Unknown error"}),a}}async upsertToIndexedDB(e,t){try{const o=await this.getFromIndexedDB(e),r=this.mergeData(o,t);await i.saveData(e,r),console.log(`✅ IndexedDB upsert 완료: ${e}`)}catch(o){throw console.error(`❌ IndexedDB upsert 실패: ${e}`,o),o}}async getFromIndexedDB(e){try{return await i.loadData(e)}catch(t){throw console.error(`❌ IndexedDB 읽기 실패: ${e}`,t),t}}mergeData(e,t){return e?t?{...e,...t}:e:t}async addToLocalQueue(e,t){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]");o.push({key:e,data:t,timestamp:Date.now()}),localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(o){throw console.error("❌ 로컬 큐 추가 실패:",o),o}}async removeFromLocalQueue(e){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]").filter(r=>r.key!==e);localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(t){throw console.error("❌ 로컬 큐 제거 실패:",t),t}}showOfflineBadge(){console.log("🔄 오프라인 모드 활성화");const e=document.createElement("div");e.textContent="오프라인 모드",e.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      z-index: 9999;
      font-size: 12px;
    `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}logTelemetry(e){this.telemetry.push(e),this.telemetry.length>100&&(this.telemetry=this.telemetry.slice(-100)),console.log(`📊 텔레메트리: ${e.operation} (${e.endTime-e.startTime}ms) ${e.success?"✅":"❌"}`)}getTelemetry(){return[...this.telemetry]}async retryLocalQueue(){try{const e=JSON.parse(localStorage.getItem("local_write_queue")||"[]");if(e.length===0){console.log("🔄 재시도할 로컬 큐 없음");return}console.log(`🔄 로컬 큐 재시도: ${e.length}개 항목`);for(const t of e)try{await this.writeWithServerFirst(t.data,async o=>(console.log("🔄 서버 재시도:",t.key),o),t.key)}catch(o){console.error("❌ 로컬 큐 재시도 실패:",t.key,o)}}catch(e){console.error("❌ 로컬 큐 재시도 실패:",e)}}}const w=new m;typeof window<"u"&&(window.serverAuthoritativeService=w);export{g as a,w as s};
