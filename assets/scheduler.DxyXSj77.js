var h=Object.defineProperty;var d=(l,e,t)=>e in l?h(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var c=(l,e,t)=>d(l,typeof e!="symbol"?e+"":e,t);import{A as i,i as u}from"./services.BsXJvLmN.js";class m{constructor(){c(this,"metadata",{lastRunAt:"",lastDateProcessed:"",inFlight:!1});c(this,"STORAGE_KEY","auto_collection_metadata");c(this,"MUTEX_KEY","auto_collection_mutex");this.loadMetadata(),this.initialize()}loadMetadata(){try{const e=localStorage.getItem(this.STORAGE_KEY);e&&(this.metadata={...this.metadata,...JSON.parse(e)})}catch(e){console.error("âŒ ìë™ ìˆ˜ì§‘ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",e)}}saveMetadata(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.metadata))}catch(e){console.error("âŒ ìë™ ìˆ˜ì§‘ ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:",e)}}initialize(){console.log("â„¹ï¸ í´ë¼ì´ì–¸íŠ¸ ìë™ ìˆ˜ì§‘ ì™„ì „ ë¹„í™œì„±í™” (ì„œë²„ ì „ìš©)"),console.log("â„¹ï¸ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ ë°ì´í„°ë§Œ ë‹¤ìš´ë¡œë“œ")}async checkAndRun(){if(this.metadata.inFlight)return;const e=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});if(this.metadata.lastDateProcessed===e){console.log("â­ï¸ ì˜¤ëŠ˜ ìë™ ìˆ˜ì§‘ ì´ë¯¸ ì™„ë£Œ:",e);return}console.log("ğŸ”„ ìë™ ìˆ˜ì§‘ í•„ìš”:",e),await this.runCollection(e)}async runCollection(e){if(sessionStorage.getItem(this.MUTEX_KEY)){console.log("â­ï¸ ìë™ ìˆ˜ì§‘ ë®¤í…ìŠ¤ ì°¨ë‹¨");return}this.metadata.inFlight=!0,sessionStorage.setItem(this.MUTEX_KEY,"true");const t=Date.now();console.log(`ğŸ”„ ìë™ ìˆ˜ì§‘ ì‹œì‘: ${e} (${new Date().toISOString()})`);try{await this.executeServerCollection(e),await this.saveToIndexedDB(e),this.metadata.lastRunAt=new Date().toISOString(),this.metadata.lastDateProcessed=e,this.saveMetadata();const o=Date.now()-t;console.log(`âœ… ìë™ ìˆ˜ì§‘ ì™„ë£Œ: ${e} (${o}ms)`)}catch(o){console.error("âŒ ìë™ ìˆ˜ì§‘ ì‹¤íŒ¨:",o),await this.enqueueRetry(e)}finally{this.metadata.inFlight=!1,sessionStorage.removeItem(this.MUTEX_KEY)}}async executeServerCollection(e){if(!i)throw new Error("API base URL is not configured.");console.log("ğŸ”„ ì„œë²„ ìë™ ìˆ˜ì§‘ ì‹¤í–‰:",e);const t=await fetch(`${i}/api/auto-collect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dateKey:e,trigger:"client"})});if(!t.ok){const r=await t.text();throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${t.status} ${r}`)}const o=await t.json();return console.log("âœ… ì„œë²„ ìë™ ìˆ˜ì§‘ ì„±ê³µ:",o),o}async saveToIndexedDB(e){console.log("ğŸ”„ IndexedDB ì €ì¥:",e);try{await new Promise(t=>setTimeout(t,500)),console.log("âœ… IndexedDB ì €ì¥ ì™„ë£Œ")}catch(t){throw console.error("âŒ IndexedDB ì €ì¥ ì‹¤íŒ¨:",t),t}}async enqueueRetry(e){console.log("ğŸ”„ ì¬ì‹œë„ íì— ì¶”ê°€:",e);try{const t=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");t.push({dateKey:e,timestamp:Date.now(),retryCount:0}),localStorage.setItem("auto_collection_retry_queue",JSON.stringify(t)),console.log("âœ… ì¬ì‹œë„ íì— ì¶”ê°€ ì™„ë£Œ")}catch(t){console.error("âŒ ì¬ì‹œë„ í ì¶”ê°€ ì‹¤íŒ¨:",t)}}async processRetryQueue(){try{const e=JSON.parse(localStorage.getItem("auto_collection_retry_queue")||"[]");if(e.length===0)return;const t=Date.now(),o=24*60*60*1e3,r=e.filter(a=>{const s=t-(a.timestamp||0);return s>o?(console.log("ğŸ—‘ï¸ ì˜¤ë˜ëœ ì¬ì‹œë„ í í•­ëª© ì œê±°:",a.dateKey,`(${Math.round(s/1e3/60/60)}ì‹œê°„ ê²½ê³¼)`),!1):!0});if(r.length!==e.length&&(localStorage.setItem("auto_collection_retry_queue",JSON.stringify(r)),console.log(`âœ… ì¬ì‹œë„ í ì •ë¦¬: ${e.length}ê°œ â†’ ${r.length}ê°œ`)),r.length===0)return;console.log(`ğŸ”„ ì¬ì‹œë„ í ì²˜ë¦¬: ${r.length}ê°œ í•­ëª©`);for(const a of r)try{await this.runCollection(a.dateKey);const s=r.filter(n=>n!==a);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(s))}catch(s){if(console.error("âŒ ì¬ì‹œë„ ì‹¤íŒ¨:",a.dateKey,s),a.retryCount=(a.retryCount||0)+1,a.retryCount>=3){const n=r.filter(g=>g!==a);localStorage.setItem("auto_collection_retry_queue",JSON.stringify(n)),console.log("âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼:",a.dateKey)}}}catch(e){console.error("âŒ ì¬ì‹œë„ í ì²˜ë¦¬ ì‹¤íŒ¨:",e)}}async triggerManualCollection(e){const t=e||new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Seoul"});console.log("ğŸ›°ï¸ ìˆ˜ë™ ìë™ìˆ˜ì§‘ íŠ¸ë¦¬ê±°:",t);const o=await this.executeServerCollection(t);return await this.saveToIndexedDB(t),this.metadata.lastRunAt=new Date().toISOString(),this.metadata.lastDateProcessed=t,this.saveMetadata(),{success:!0,dateKey:t,result:o}}getMetadata(){return{...this.metadata}}}const w=new m;typeof window<"u"&&(window.autoCollectionScheduler=w);class f{constructor(){c(this,"telemetry",[])}async readWithServerFirst(e,t,o){const r=Date.now(),a=`fetch_${t}`;try{console.log(`ğŸ”„ ì„œë²„ ìš°ì„  ì½ê¸° ì‹œì‘: ${t}`);const s=await e();return console.log(`âœ… ì„œë²„ ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${t}`),await this.upsertToIndexedDB(t,s),console.log(`âœ… IndexedDB ìºì‹œ ì €ì¥: ${t}`),this.logTelemetry({operation:a,startTime:r,endTime:Date.now(),success:!0}),s}catch(s){console.error(`âŒ ì„œë²„ ì½ê¸° ì‹¤íŒ¨: ${t}`,s);try{const n=await this.getFromIndexedDB(o||t);return console.log(`ğŸ”„ IndexedDB í´ë°± ì‚¬ìš©: ${t}`),this.showOfflineBadge(),this.logTelemetry({operation:a,startTime:r,endTime:Date.now(),success:!0}),n}catch(n){throw console.error(`âŒ IndexedDB í´ë°± ì‹¤íŒ¨: ${t}`,n),this.logTelemetry({operation:a,startTime:r,endTime:Date.now(),success:!1,error:n instanceof Error?n.message:"Unknown error"}),n}}}async writeWithServerFirst(e,t,o){const r=Date.now(),a=`save_${o}`;try{console.log(`ğŸ”„ ì„œë²„ ìš°ì„  ì“°ê¸° ì‹œì‘: ${o}`),await this.addToLocalQueue(o,e),console.log(`âœ… ë¡œì»¬ í ì¶”ê°€: ${o}`);const s=await t(e);console.log(`âœ… ì„œë²„ ì €ì¥ ì„±ê³µ: ${o}`),await this.upsertToIndexedDB(o,s),console.log(`âœ… IndexedDB ì„œë²„ ì‘ë‹µ ì—…ë°ì´íŠ¸: ${o}`),await this.removeFromLocalQueue(o),console.log(`âœ… ë¡œì»¬ í ì œê±°: ${o}`),this.logTelemetry({operation:a,startTime:r,endTime:Date.now(),success:!0})}catch(s){throw console.error(`âŒ ì„œë²„ ì“°ê¸° ì‹¤íŒ¨: ${o}`,s),console.log(`ğŸ”„ ë¡œì»¬ í ìœ ì§€ (ì¬ì‹œë„ ëŒ€ê¸°): ${o}`),this.logTelemetry({operation:a,startTime:r,endTime:Date.now(),success:!1,error:s instanceof Error?s.message:"Unknown error"}),s}}async upsertToIndexedDB(e,t){try{const o=await this.getFromIndexedDB(e),r=this.mergeData(o,t);await u.saveData(e,r),console.log(`âœ… IndexedDB upsert ì™„ë£Œ: ${e}`)}catch(o){throw console.error(`âŒ IndexedDB upsert ì‹¤íŒ¨: ${e}`,o),o}}async getFromIndexedDB(e){try{return await u.loadData(e)}catch(t){throw console.error(`âŒ IndexedDB ì½ê¸° ì‹¤íŒ¨: ${e}`,t),t}}mergeData(e,t){return e?t?{...e,...t}:e:t}async addToLocalQueue(e,t){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]");o.push({key:e,data:t,timestamp:Date.now()}),localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(o){throw console.error("âŒ ë¡œì»¬ í ì¶”ê°€ ì‹¤íŒ¨:",o),o}}async removeFromLocalQueue(e){try{const o=JSON.parse(localStorage.getItem("local_write_queue")||"[]").filter(r=>r.key!==e);localStorage.setItem("local_write_queue",JSON.stringify(o))}catch(t){throw console.error("âŒ ë¡œì»¬ í ì œê±° ì‹¤íŒ¨:",t),t}}showOfflineBadge(){console.log("ğŸ”„ ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”");const e=document.createElement("div");e.textContent="ì˜¤í”„ë¼ì¸ ëª¨ë“œ",e.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      z-index: 9999;
      font-size: 12px;
    `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}logTelemetry(e){this.telemetry.push(e),this.telemetry.length>100&&(this.telemetry=this.telemetry.slice(-100)),console.log(`ğŸ“Š í…”ë ˆë©”íŠ¸ë¦¬: ${e.operation} (${e.endTime-e.startTime}ms) ${e.success?"âœ…":"âŒ"}`)}getTelemetry(){return[...this.telemetry]}async retryLocalQueue(){try{const e=JSON.parse(localStorage.getItem("local_write_queue")||"[]");if(e.length===0){console.log("ğŸ”„ ì¬ì‹œë„í•  ë¡œì»¬ í ì—†ìŒ");return}console.log(`ğŸ”„ ë¡œì»¬ í ì¬ì‹œë„: ${e.length}ê°œ í•­ëª©`);for(const t of e)try{await this.writeWithServerFirst(t.data,async o=>(console.log("ğŸ”„ ì„œë²„ ì¬ì‹œë„:",t.key),o),t.key)}catch(o){console.error("âŒ ë¡œì»¬ í ì¬ì‹œë„ ì‹¤íŒ¨:",t.key,o)}}catch(e){console.error("âŒ ë¡œì»¬ í ì¬ì‹œë„ ì‹¤íŒ¨:",e)}}}const S=new f;typeof window<"u"&&(window.serverAuthoritativeService=S);export{w as a,S as s};
