<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¡œì»¬ í‚¤ì›Œë“œ ë¶„ë¥˜ ì´ˆê¸°í™”</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #c82333;
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    #log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      color: #856404;
    }
    .info {
      background-color: #d1ecf1;
      border: 1px solid #17a2b8;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ ë¡œì»¬ í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¶„ë¥˜ ì´ˆê¸°í™”</h1>
    
    <div class="warning">
      <strong>âš ï¸ ì£¼ì˜:</strong> ì´ ë„êµ¬ëŠ” ë¡œì»¬ IndexedDBì—ì„œ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¶„ë¥˜ëœ ë°ì´í„°ë¥¼ ì°¾ì•„ì„œ ë¯¸ë¶„ë¥˜ ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
      <br><br>
      ë‹¤ìŒ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤:
      <ul>
        <li><code>classificationConfidence</code> ë˜ëŠ” <code>matchedKeywords</code> í•„ë“œê°€ ìˆëŠ” ë°ì´í„°</li>
        <li><code>autoClassified: true</code>ì´ê³  <code>status: 'classified'</code>ì¸ ë°ì´í„°</li>
      </ul>
      <strong>14ì¼ ë°ì´í„° ê¸°ë°˜ ìë™ ë¶„ë¥˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.</strong>
    </div>
    
    <div class="info">
      <strong>â„¹ï¸ ì•ˆë‚´:</strong> ì´ˆê¸°í™” í›„ ì„œë²„ì— ì—…ë¡œë“œí•˜ë ¤ë©´ "ë°ì´í„° ë¶„ë¥˜ ê´€ë¦¬" í˜ì´ì§€ì—ì„œ "ì§„í–‰ë¥  ì¼ê´„ ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
    </div>
    
    <button class="btn" onclick="checkData()">1ë‹¨ê³„: í‚¤ì›Œë“œ ë¶„ë¥˜ ë°ì´í„° í™•ì¸</button>
    <button class="btn" onclick="resetData()" id="resetBtn" disabled>2ë‹¨ê³„: ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½</button>
    <button class="btn btn-secondary" onclick="location.href='/'">í™ˆìœ¼ë¡œ</button>
    
    <div id="log"></div>
  </div>

  <script>
    let keywordClassifiedData = [];
    
    function log(message) {
      const logDiv = document.getElementById('log');
      logDiv.textContent += message + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function clearLog() {
      document.getElementById('log').textContent = '';
    }
    
    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('YouTubePulseDB', 3);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    async function loadUnclassifiedData() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['unclassifiedData'], 'readonly');
        const store = transaction.objectStore('unclassifiedData');
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    async function saveUnclassifiedData(data) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['unclassifiedData'], 'readwrite');
        const store = transaction.objectStore('unclassifiedData');
        
        let completed = 0;
        const total = data.length;
        
        data.forEach(item => {
          const request = store.put(item);
          request.onsuccess = () => {
            completed++;
            if (completed === total) {
              resolve();
            }
          };
          request.onerror = () => {
            console.error('ì €ì¥ ì‹¤íŒ¨:', item.id);
          };
        });
      });
    }
    
    async function checkData() {
      clearLog();
      log('ğŸ” ë¡œì»¬ IndexedDB ë°ì´í„° í™•ì¸ ì¤‘...\n');
      
      try {
        const allData = await loadUnclassifiedData();
        log(`âœ… ì „ì²´ ë°ì´í„°: ${allData.length}ê°œ\n`);
        
        // í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¶„ë¥˜ ë°ì´í„° ì°¾ê¸°
        keywordClassifiedData = allData.filter(item => {
          const hasConfidence = item.classificationConfidence !== undefined && item.classificationConfidence !== null;
          const hasKeywords = item.matchedKeywords && item.matchedKeywords.length > 0;
          const isAutoClassified = item.autoClassified === true;
          const isClassified = item.status === 'classified';
          
          return (hasConfidence || hasKeywords) && isAutoClassified && isClassified;
        });
        
        log(`ğŸ” í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¶„ë¥˜ ë°ì´í„°: ${keywordClassifiedData.length}ê°œ\n`);
        
        if (keywordClassifiedData.length === 0) {
          log('âœ… í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¶„ë¥˜ ë°ì´í„° ì—†ìŒ!');
          document.getElementById('resetBtn').disabled = true;
          return;
        }
        
        // ë‚ ì§œë³„ ë¶„í¬
        const dateDistribution = {};
        keywordClassifiedData.forEach(item => {
          let date = item.dayKeyLocal || item.collectionDate || item.uploadDate;
          if (date && typeof date === 'string' && date.includes('T')) {
            date = date.split('T')[0];
          }
          if (date) {
            dateDistribution[date] = (dateDistribution[date] || 0) + 1;
          }
        });
        
        log('ğŸ“… ë‚ ì§œë³„ í‚¤ì›Œë“œ ë¶„ë¥˜ ë°ì´í„° ë¶„í¬:');
        Object.keys(dateDistribution).sort().forEach(date => {
          log(`   ${date}: ${dateDistribution[date]}ê°œ`);
        });
        
        log('\nğŸ“‹ ìƒ˜í”Œ ë°ì´í„° (ìµœëŒ€ 5ê°œ):');
        keywordClassifiedData.slice(0, 5).forEach(item => {
          log(`   - ${item.videoTitle.substring(0, 50)}...`);
          log(`     ì¹´í…Œê³ ë¦¬: ${item.category} > ${item.subCategory}`);
          log(`     ì‹ ë¢°ë„: ${item.classificationConfidence || 'N/A'}`);
          log(`     í‚¤ì›Œë“œ: ${item.matchedKeywords ? item.matchedKeywords.join(', ') : 'N/A'}`);
          log('');
        });
        
        document.getElementById('resetBtn').disabled = false;
        log('âœ… í™•ì¸ ì™„ë£Œ! ìœ„ì˜ "2ë‹¨ê³„" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½í•˜ì„¸ìš”.');
        
      } catch (error) {
        log('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        console.error(error);
      }
    }
    
    async function resetData() {
      if (keywordClassifiedData.length === 0) {
        alert('ë¨¼ì € 1ë‹¨ê³„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
        return;
      }
      
      if (!confirm(`${keywordClassifiedData.length}ê°œì˜ í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¶„ë¥˜ ë°ì´í„°ë¥¼ ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      clearLog();
      log('ğŸ”„ ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½ ì¤‘...\n');
      
      try {
        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        const allData = await loadUnclassifiedData();
        
        // í‚¤ì›Œë“œ ë¶„ë¥˜ ë°ì´í„°ì˜ ID ì„¸íŠ¸ ìƒì„±
        const keywordIds = new Set(keywordClassifiedData.map(item => item.id));
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸
        const updatedData = allData.map(item => {
          if (keywordIds.has(item.id)) {
            return {
              ...item,
              status: 'unclassified',
              category: '',
              subCategory: '',
              autoClassified: false,
              classificationConfidence: undefined,
              matchedKeywords: undefined
            };
          }
          return item;
        });
        
        // ì €ì¥
        log('ğŸ’¾ IndexedDBì— ì €ì¥ ì¤‘...');
        await saveUnclassifiedData(updatedData);
        
        log(`âœ… ${keywordClassifiedData.length}ê°œ ë°ì´í„° ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½ ì™„ë£Œ!\n`);
        log('ğŸ“¤ ë‹¤ìŒ ë‹¨ê³„: "ë°ì´í„° ë¶„ë¥˜ ê´€ë¦¬" í˜ì´ì§€ì—ì„œ "ì§„í–‰ë¥  ì¼ê´„ ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„œë²„ì— ì—…ë¡œë“œí•˜ì„¸ìš”.');
        
        keywordClassifiedData = [];
        document.getElementById('resetBtn').disabled = true;
        
      } catch (error) {
        log('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        console.error(error);
      }
    }
  </script>
</body>
</html>

